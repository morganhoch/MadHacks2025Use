{% extends "base.html" %}

{% block title %}{{ course.course_code }} - ConnectU{% endblock %}

{% block content %}
<div class="course-container">
    <h1>{{ course.course_code }} - {{ course.title }}</h1>

    {% if course.description %}
        <p>{{ course.description }}</p>
    {% endif %}

    <!-- Join / Leave Course -->
    {% set joined = None %}
    {% if user %}
        {% for uc in user.user_courses %}
            {% if uc.course.id == course.id %}
                {% set joined = uc %}
            {% endif %}
        {% endfor %}
    {% endif %}

    {% if joined %}
        <p>You are enrolled as <strong>{{ joined.status }}</strong> for <strong>{{ joined.term }}</strong>.</p>
        <form action="{{ url_for('leave_course', course_id=course.id) }}" method="post" style="display:inline;">
            <button type="submit" class="btn btn-danger">Leave Course</button>
        </form>
    {% elif user %}
        <form action="{{ url_for('join_course', course_id=course.id) }}" method="post" style="margin-top:1em;">
            <label for="status">Status:</label>
            <select name="status" id="status" required>
                <option value="student">Student</option>
                <option value="tutor">Tutor</option>
            </select>

            <label for="term">Term:</label>
            <input type="text" name="term" id="term" placeholder="Fall'25" required>

            <button type="submit" class="btn btn-primary">Join Course</button>
        </form>
    {% else %}
        <p><a href="{{ url_for('login') }}">Log in</a> to join this course.</p>
    {% endif %}

    <!-- Users in this course -->
    <h2>Users in this course</h2>
    {% if course.user_courses %}
        <ul class="course-users">
        {% for uc in course.user_courses %}
            <li>
                <a href="{{ url_for('profile_view', user_id=uc.user.id) }}">{{ uc.user.username }}</a>
                - {{ uc.status }} ({{ uc.term }})
            </li>
        {% endfor %}
        </ul>
    {% else %}
        <p>No one has joined this course yet.</p>
    {% endif %}

    {% if madgrades_info %}
    <hr>
    <h2>Official Course Info</h2>
    <p><strong>Description:</strong> {{ madgrades_info.description or "N/A" }}</p>
    <p><strong>Prerequisites:</strong> {{ madgrades_info.prerequisites or "None listed" }}</p>
    <p><strong>Cross-listed Subjects:</strong> 
        {% if madgrades_info.cross_listed_subjects %}
            {{ madgrades_info.cross_listed_subjects | join(", ") }}
        {% else %}
            None
        {% endif %}
    </p>
    <p><strong>Instructor(s):</strong>
        {% if madgrades_info.instructors %}
            {% for inst in madgrades_info.instructors %}
                {{ inst.name }}{% if not loop.last %}, {% endif %}
            {% endfor %}
        {% else %}
            N/A
        {% endif %}
    </p>
    <p><strong>Past Offerings:</strong> {{ madgrades_info.offerings_count or 0 }}</p>
    {% endif %}

    <hr>
    <h2>Ask a Question</h2>
    {% if session.user %}
        <form method="POST">
            <textarea name="content" placeholder="Type your question here..." required></textarea>
            <button type="submit" name="question">Post Question</button>
        </form>
    {% else %}
        <p><a href="{{ url_for('login') }}">Log in</a> to ask a question.</p>
    {% endif %}

    <h2>Questions & Answers</h2>
    {% if questions %}
        {% for q in questions %}
            <div class="question-block">
                <p><strong>{{ q.user.username }}</strong> asked:</p>
                <p>{{ q.content }}</p>

                <ul>
                {% for a in q.answers %}
                    <li><strong>{{ a.user.username }}</strong> answered: {{ a.content }}</li>
                {% endfor %}
                </ul>

                {% if session.user %}
                    <form method="POST">
                        <textarea name="content" placeholder="Type your answer here..." required></textarea>
                        <input type="hidden" name="question_id" value="{{ q.id }}">
                        <button type="submit" name="answer">Post Answer</button>
                    </form>
                {% endif %}
            </div>
        {% endfor %}
    {% else %}
        <p>No questions yet. Be the first to ask!</p>
    {% endif %}
</div>
{% endblock %}
