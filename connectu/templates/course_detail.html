{% extends "base.html" %}

{% block title %}{{ course.course_code }} - ConnectU{% endblock %}

{% block content %}
<div class="course-container">
    <div class="course-main-info-right">
        <h1>{{ course.course_code }} - {{ course.title }}</h1>

        {% if course.description %}
            <p>{{ course.description }}</p>
        {% endif %}

        {# Check if current user is enrolled #}
        {% if user %}
            {% set enrolled = false %}
            {% for uc in course.students %}
                {% if uc.user.id == user.id %}
                    {% set enrolled = true %}
                {% endif %}
            {% endfor %}

            {% if enrolled %}
                <form action="{{ url_for('leave_course', course_id=course.id) }}" method="post" style="display:inline;">
                    <button type="submit" class="btn btn-danger">Leave Course</button>
                </form>
            {% else %}
                <form action="{{ url_for('join_course', course_id=course.id) }}" method="post" class="join-course-form">
                    <label for="status">Status:</label>
                    <select name="status" id="status" required>
                        <option value="">-- Select --</option>
                        <option value="Tutor">Tutor</option>
                        <option value="Student">Student</option>
                    </select>

                    <label for="term">Term:</label>
                    <select name="term" id="term" required>
                        <option value="">-- Select --</option>
                        <option value="Fall 2020">Fall 2020</option>
                        <option value="Spring 2021">Spring 2021</option>
                        <option value="Fall 2021">Fall 2021</option>
                        <option value="Spring 2022">Spring 2022</option>
                        <option value="Fall 2022">Fall 2022</option>
                        <option value="Spring 2023">Spring 2023</option>
                        <option value="Fall 2023">Fall 2023</option>
                        <option value="Spring 2024">Spring 2024</option>
                        <option value="Fall 2024">Fall 2024</option>
                        <option value="Spring 2025">Spring 2025</option>
                        <option value="Fall 2025">Fall 2025</option>
                    </select>

                    <button type="submit" class="btn btn-success">Join Course</button>
                </form>

        <hr>
        <h2>Ask a Question</h2>
        {% if user %}
            <form method="POST">
                <textarea name="content" placeholder="Type your question here..." required></textarea>
                <button type="submit" name="question">Post Question</button>
            </form>
        {% else %}
            <p><a href="{{ url_for('login') }}">Log in</a> to ask a question.</p>
        {% endif %}

        <h2>Questions & Answers</h2>
        {% if questions %}
            {% for q in questions %}
                <div class="question-block">
                    <p><strong>{{ q.user.username }}</strong> asked:</p>
                    <p>{{ q.content }}</p>

                    <ul>
                        {% for a in q.answers %}
                            <li><strong>{{ a.user.username }}</strong> answered: {{ a.content }}</li>
                        {% endfor %}
                    </ul>

                    {% if user and user.auth0_id == q.user.auth0_id %}
                        <form action="{{ url_for('remove_question', question_id=q.id) }}" method="post" style="display:inline;">
                            <button type="submit" class="btn-danger btn-sm">Remove Question</button>
                        </form>
                    {% endif %}

                    {% if session.user %}
                        <form method="POST">
                            <textarea name="content" placeholder="Type your answer here..." required></textarea>
                            <input type="hidden" name="question_id" value="{{ q.id }}">
                            <button type="submit" name="answer">Post Answer</button>
                        </form>
                    {% endif %}
                </div>
            {% endfor %}
        {% else %}
            <p>No questions yet.</p>
        {% endif %}
    </div>

    <div class="enrolled-users-sidebar">
        <h2>Users in this course</h2>
        {% if enrolled_users %}
            <ul class="course-users">
                {% for uc in enrolled_users %}
                    <li>
                        <a href="{{ url_for('profile_view', user_id=uc.user.id) }}">
                            {{ uc.user.username }}
                        </a>
                        â€“ {{ uc.status }} ({{ uc.term }})
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p>No one has joined this course yet.</p>
        {% endif %}
    </div>
</div>
{% endblock %}
