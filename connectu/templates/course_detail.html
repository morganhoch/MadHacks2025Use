{% extends "base.html" %}

{% block title %}{{ course.course_code }} - ConnectU{% endblock %}

{% block content %}
<div class="course-container" style="display: flex; gap: 32px; align-items: flex-start;">
    
    <!-- Main course content -->
    <div class="course-main-info-right" style="flex: 3 1 0;">

        <h1>{{ course.course_code.replace('_', ' ') }} </h1>

        {% if course.description %}
            <p>{{ course.description }}</p>
        {% endif %}

        {# Check if current user is enrolled #}
        {% if user %}
            {% set enrolled = false %}
            {% for uc in course.students %}
                {% if uc.user.id == user.id %}
                    {% set enrolled = true %}
                {% endif %}
            {% endfor %}

            {% if enrolled %}
                <!-- Leave Course -->
                <form action="{{ url_for('leave_course', course_id=course.id) }}" method="post" style="display:inline;">
                    <button type="submit" class="btn btn-danger">Leave Course</button>
                </form>
            {% else %}
                <!-- JOIN COURSE FORM -->
                <form action="{{ url_for('join_course', course_id=course.id) }}" method="post" class="join-course-form">
                    <label for="status">Your Status in This Class:</label>
                    <select name="status" required>
                        <option value="">Select…</option>
                        <option value="Student">Student</option>
                        <option value="Tutor">Tutor</option>
                    </select>

                    <label for="term">Term Taken:</label>
                    <select name="term" required>
                        <option value="">Select…</option>
                        <option value="Fall 2025">Fall 2025</option>
                        <option value="Spring 2025">Spring 2025</option>
                        <option value="Fall 2024">Fall 2024</option>
                        <option value="Spring 2024">Spring 2024</option>
                        <option value="Fall 2023">Fall 2023</option>
                        <option value="Spring 2023">Spring 2023</option>
                        <option value="Fall 2022">Fall 2022</option>
                        <option value="Spring 2022">Spring 2022</option>
                    </select>

                    <button type="submit" class="btn btn-primary">Join Course</button>
                </form>
            {% endif %}
        {% endif %}

        <hr>
        <h2>Ask a Question</h2>
        {% if user %}
            <form method="POST">
                <textarea name="content" placeholder="Type your question here..." required></textarea>
                <button type="submit" name="question">Post Question</button>
            </form>
        {% else %}
            <p><a href="{{ url_for('login') }}">Log in</a> to ask a question.</p>
        {% endif %}

        <h2>Questions & Answers</h2>
        {% if questions %}
            {% for q in questions %}
                <div class="question-block" style="border: 1px solid #ddd; border-radius: 8px; padding: 10px; margin-bottom: 10px;">
                    <p><strong>{{ q.user.username }}</strong> asked:</p>
                    <p>{{ q.content }}</p>

                    <ul>
                        {% for a in q.answers %}
                            <li><strong>{{ a.user.username }}</strong> answered: {{ a.content }}</li>
                        {% endfor %}
                    </ul>

                    {% if user and user.auth0_id == q.user.auth0_id %}
                        <form action="{{ url_for('remove_question', question_id=q.id) }}" method="post" style="display:inline;">
                            <button type="submit" class="btn-danger btn-sm">Remove Question</button>
                        </form>
                    {% endif %}

                    {% if session.user %}
                        <form method="POST">
                            <textarea name="content" placeholder="Type your answer here..." required></textarea>
                            <input type="hidden" name="question_id" value="{{ q.id }}">
                            <button type="submit" name="answer">Post Answer</button>
                        </form>
                    {% endif %}
                </div>
            {% endfor %}
        {% else %}
            <p>No questions yet.</p>
        {% endif %}

    <!-- ===== Document Upload Section ===== -->
<section class="class-documents" style="margin-top: 2em;">
    <h3>Class Documents</h3>

    <!-- Upload Form -->
    <form action="{{ url_for('upload_document', course_id=course.id) }}" method="POST" enctype="multipart/form-data" style="margin-bottom: 1em;">
        <input type="file" name="document" required>
        <button type="submit" class="btn-primary">Upload</button>
    </form>

    <!-- Document Gallery -->
    <div class="document-gallery" style="display: flex; flex-wrap: wrap; gap: 20px; max-height: 600px; overflow-y: auto;">
        {% for doc in course.documents %}
            {% set ext = doc.filename.split('.')[-1].lower() %}
            {% if ext in ['png', 'jpg', 'jpeg', 'gif'] %}
                {% set icon = url_for('static', filename='uploads/' + doc.filename) %}
            {% elif ext == 'pdf' %}
                {% set icon = url_for('static', filename='icons/pdf.png') %}
            {% elif ext == 'docx' %}
                {% set icon = url_for('static', filename='icons/docx.png') %}
            {% elif ext == 'pptx' %}
                {% set icon = url_for('static', filename='icons/pptx.png') %}
            {% elif ext == 'txt' %}
                {% set icon = url_for('static', filename='icons/txt.png') %}
            {% else %}
                {% set icon = url_for('static', filename='icons/file.png') %}
            {% endif %}

            <div class="doc-card" style="width: 150px; border: 1px solid #ba0c2f; border-radius: 10px; padding: 10px; background: #fff; box-shadow: 0 2px 6px rgba(0,0,0,0.1); text-align: center;">
                <a href="{{ url_for('static', filename='uploads/' + doc.filename) }}" target="_blank">
                    <img src="{{ icon }}" alt="{{ ext }} icon" style="width: 100px; height: 100px; object-fit: cover; margin-bottom: 10px; border-radius: 6px;">
                    <div style="font-weight: 700; color: #ba0c2f; font-size: 0.9em; word-wrap: break-word;">{{ doc.filename }}</div>
                </a>
                <p style="font-size: 0.75em; color: #555; margin: 5px 0 0;">Uploaded by {{ doc.user.username }}</p>
                <p style="font-size: 0.7em; color: #888; margin: 2px 0 0;">{{ doc.uploaded_at.strftime('%Y-%m-%d') }}</p>
            </div>
        {% endfor %}
    </div>
</section>


    <!-- Sidebar -->
    <div class="enrolled-users-sidebar" style="flex: 1 1 0; min-width: 250px; background: #fff0f3; border-radius: 8px; padding: 16px;">
        <h2>Users in this course</h2>
        {% if enrolled_users %}
            <ul class="course-users">
                {% for uc in enrolled_users %}
                    <li>
                        <a href="{{ url_for('profile_view', user_id=uc.user.id) }}">
                            {{ uc.user.username }}
                        </a>
                        – {{ uc.status }} ({{ uc.term }})
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p>No one has joined this course yet.</p>
        {% endif %}
    </div>

</div>
{% endblock %}
